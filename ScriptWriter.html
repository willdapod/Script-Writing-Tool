<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptWriter Pro | Distraction-Free Screenwriting</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter & Courier Prime -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            overflow: hidden;
        }

        .courier {
            font-family: 'Courier Prime', monospace;
        }

        /* Editor Styles */
        #editor {
            outline: none;
            min-height: 100%;
            line-height: 1.2;
            padding-bottom: 50vh;
        }

        /* Fountain Elements */
        .scene-heading {
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .character {
            text-align: center;
            width: 50%;
            margin: 1.5rem auto 0 auto;
            text-transform: uppercase;
            font-weight: bold;
        }

        .parenthetical {
            text-align: center;
            width: 35%;
            margin: 0 auto;
            font-style: italic;
        }

        .dialogue {
            text-align: center;
            width: 60%;
            margin: 0 auto 1rem auto;
        }

        .transition {
            text-align: right;
            text-transform: uppercase;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            color: #fbbf24;
        }

        .action {
            margin-bottom: 1rem;
        }

        /* Glassmorphism Sidebar */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Transitions */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #475569;
            cursor: text;
        }
    </style>
</head>

<body class="h-screen flex flex-col">

    <!-- Header / Navigation -->
    <header
        class="h-14 border-b border-slate-800 flex items-center justify-between px-6 shrink-0 z-50 bg-slate-900/50 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-sky-500 rounded-lg flex items-center justify-center">
                <i data-lucide="pen-tool" class="w-4 h-4 text-white"></i>
            </div>
            <h1 class="text-lg font-semibold tracking-tight">ScriptWriter <span class="text-sky-400">Pro</span></h1>
        </div>

        <div class="flex items-center gap-4">
            <div id="save-status" class="text-xs text-slate-500 flex items-center gap-1.5">
                <i data-lucide="check-circle" class="w-3 h-3 text-emerald-500"></i>
                Saved to local
            </div>
            <div class="h-4 w-px bg-slate-700"></div>
            <button onclick="exportToText()" class="p-2 hover:bg-slate-800 rounded-lg transition-colors group"
                title="Export as Text">
                <i data-lucide="download" class="w-5 h-5 text-slate-400 group-hover:text-white"></i>
            </button>
            <button class="p-2 hover:bg-slate-800 rounded-lg transition-colors group" title="Settings">
                <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-white"></i>
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">

        <!-- Sidebar -->
        <aside class="w-64 glass-panel shrink-0 flex flex-col">
            <div class="p-4 flex-1 overflow-y-auto space-y-6">
                <!-- Scenes Section -->
                <section>
                    <div class="flex items-center justify-between mb-3 px-1">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-slate-500">Scenes</h2>
                        <button class="text-sky-400 hover:text-sky-300 transform transition-transform hover:scale-110">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="scene-list" class="space-y-1">
                        <!-- Scenes will be injected here -->
                        <div class="text-xs text-slate-600 italic px-2">No scenes found.</div>
                    </div>
                </section>

                <!-- Characters Section -->
                <section>
                    <div class="flex items-center justify-between mb-3 px-1">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-slate-500">Characters</h2>
                    </div>
                    <div id="character-list" class="flex flex-wrap gap-2">
                        <!-- Characters will be injected here -->
                    </div>
                </section>
            </div>

            <!-- User Footer -->
            <div class="p-4 border-t border-slate-800/50 bg-slate-900/30">
                <button onclick="toggleSidebar()"
                    class="w-full py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs font-semibold transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="eye-off" class="w-3 h-3"></i>
                    Focus Mode
                </button>
            </div>
        </aside>

        <!-- Main Editor Area -->
        <main class="flex-1 overflow-hidden relative flex flex-col">

            <!-- Toolbar (Floating) -->
            <div
                class="absolute bottom-8 left-1/2 -translate-x-1/2 bg-slate-800/80 backdrop-blur-xl border border-slate-700/50 rounded-full px-6 py-3 flex items-center gap-6 shadow-2xl z-40 transition-all hover:border-sky-500/30 print:hidden">
                <button onclick="insertAtCursor('scene-heading')" class="flex flex-col items-center gap-1 group">
                    <i data-lucide="film" class="w-5 h-5 text-slate-400 group-hover:text-sky-400 transition-colors"></i>
                    <span
                        class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter group-hover:text-sky-400">Scene</span>
                </button>
                <div class="w-px h-6 bg-slate-700"></div>
                <button onclick="insertAtCursor('character')" class="flex flex-col items-center gap-1 group">
                    <i data-lucide="user" class="w-5 h-5 text-slate-400 group-hover:text-sky-400 transition-colors"></i>
                    <span
                        class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter group-hover:text-sky-400">Char</span>
                </button>
                <div class="w-px h-6 bg-slate-700"></div>
                <button onclick="insertAtCursor('dialogue')" class="flex flex-col items-center gap-1 group">
                    <i data-lucide="message-square"
                        class="w-5 h-5 text-slate-400 group-hover:text-sky-400 transition-colors"></i>
                    <span
                        class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter group-hover:text-sky-400">Diag</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-12 md:px-24 py-12 print:p-0" id="editor-container">
                <div class="max-w-3xl mx-auto bg-white/5 p-12 md:p-24 shadow-inner min-h-screen courier text-lg print:bg-white print:text-black print:p-0 print:shadow-none print:max-w-full"
                    id="editor" contenteditable="true" placeholder="EXT. ABANDONED STUDIO - DAY">
                </div>
            </div>
        </main>
    </div>

    <style print>
        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            header,
            aside,
            .absolute,
            .print\:hidden {
                display: none !important;
            }

            #editor-container {
                padding: 1in !important;
            }

            #editor {
                padding: 0 !important;
                background: transparent !important;
            }

            .scene-heading {
                color: black !important;
                margin-top: 0.5in !important;
            }
        }
    </style>

    <script>
        lucide.createIcons();

        const editor = document.getElementById('editor');
        const saveStatus = document.getElementById('save-status');
        const sceneList = document.getElementById('scene-list');
        const characterList = document.getElementById('character-list');

        let scenes = [];
        let characters = new Set();

        // Intelligent Tab Handling
        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const line = range.startContainer.parentElement;

                // Cycle between Action -> Character -> Dialogue
                if (line.classList.contains('action') || line === editor) {
                    formatLine(line, 'character');
                } else if (line.classList.contains('character')) {
                    formatLine(line, 'dialogue');
                } else {
                    formatLine(line, 'action');
                }
            }
            if (e.key === 'Enter') {
                // Focus character after scene heading? Not for now, keep it manual/auto
            }
        });

        function formatLine(element, type) {
            element.className = 'courier ' + type;
            if (type === 'character' || type === 'scene-heading' || type === 'transition') {
                element.style.textTransform = 'uppercase';
            } else {
                element.style.textTransform = 'none';
            }
        }

        editor.addEventListener('input', () => {
            updateSaveStatus('Saving...');
            parseScript();
            debouncedSave();
        });

        function parseScript() {
            const tempScenes = [];
            const tempChars = new Set();

            // Basic line-by-line parsing
            const lines = editor.innerText.split('\n');
            lines.forEach((line, index) => {
                const trimmed = line.trim();

                // Scene Heading Detection
                if (trimmed.startsWith('INT.') || trimmed.startsWith('EXT.') || trimmed.startsWith('I/E.')) {
                    tempScenes.push({ title: trimmed, index });
                }

                // Character Detection (Heuristic: All caps, not too long, not a heading)
                if (trimmed === trimmed.toUpperCase() && trimmed.length > 1 && trimmed.length < 30 &&
                    !trimmed.startsWith('INT.') && !trimmed.startsWith('EXT.') && !trimmed.endsWith(':')) {
                    tempChars.add(trimmed);
                }
            });

            updateSidebars(tempScenes, Array.from(tempChars));
        }

        function updateSidebars(newScenes, newChars) {
            // Update Scenes
            if (newScenes.length === 0) {
                sceneList.innerHTML = '<div class="text-xs text-slate-600 italic px-2">No scenes found.</div>';
            } else {
                sceneList.innerHTML = newScenes.map(s => `
                    <button class="w-full text-left px-2 py-1.5 rounded hover:bg-slate-800 text-xs text-slate-300 truncate transition-colors border-l-2 border-transparent hover:border-sky-500">
                        <span class="text-slate-500 mr-2 font-mono">${(newScenes.indexOf(s) + 1).toString().padStart(2, '0')}</span>
                        ${s.title}
                    </button>
                `).join('');
            }

            // Update Characters
            characterList.innerHTML = newChars.map(c => `
                <div class="px-2 py-1 bg-slate-800 rounded text-[10px] font-bold text-sky-400 border border-slate-700 hover:border-sky-500 cursor-default transition-all">
                    ${c}
                </div>
            `).join('');
        }

        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem('script_draft', editor.innerHTML);
                updateSaveStatus('Saved', true);
            }, 1000);
        }

        function updateSaveStatus(text, isDone) {
            saveStatus.innerHTML = `
                <i data-lucide="${isDone ? 'check-circle' : 'refresh-cw'}" class="w-3 h-3 ${isDone ? 'text-emerald-500' : 'animate-spin text-sky-500'}"></i>
                ${text}
            `;
            lucide.createIcons();
        }

        window.onload = () => {
            const saved = localStorage.getItem('script_draft');
            if (saved) {
                editor.innerHTML = saved;
                parseScript();
            } else {
                // Initial boilerplate
                editor.innerHTML = '<div class="scene-heading">EXT. ABANDONED STUDIO - DAY</div><div class="action">The camera pans across a dusty floor.</div>';
                parseScript();
            }
        };

        async function exportToText() {
            const text = editor.innerText;
            try {
                // Try File System Access API first
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'my_script.fountain',
                    types: [{
                        description: 'Fountain Script',
                        accept: { 'text/plain': ['.fountain', '.txt'] },
                    }],
                });
                const writable = await handle.createWritable();
                await writable.write(text);
                await writable.close();
            } catch (err) {
                // Fallback to traditional download
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'my_script.fountain';
                a.click();
            }
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('aside');
            const isHidden = sidebar.classList.contains('hidden');
            if (isHidden) {
                sidebar.classList.remove('hidden');
            } else {
                sidebar.classList.add('hidden');
            }
        }

        function insertAtCursor(type) {
            const div = document.createElement('div');
            div.innerHTML = '&nbsp;';
            formatLine(div, type);
            editor.appendChild(div);
            // Focus and select the new line
            const range = document.createRange();
            const sel = window.getSelection();
            range.setStart(div, 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            div.focus();
            parseScript();
        }
    </script>
</body>

</html>